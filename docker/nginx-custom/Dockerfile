############################
# ğŸ‘· ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º nginx + rtmp æ¨¡å—
############################
FROM alpine:3.19 AS builder

ENV NGINX_VERSION=1.24.0

# å®‰è£…ç¼–è¯‘ä¾èµ–
RUN apk add --no-cache \
    build-base \
    pcre-dev \
    openssl-dev \
    zlib-dev \
    git \
    wget

WORKDIR /build

# ä¸‹è½½ nginx æºç 
RUN wget http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz && \
    tar zxvf nginx-${NGINX_VERSION}.tar.gz

# å…‹éš† rtmp æ¨¡å—
RUN git clone https://github.com/arut/nginx-rtmp-module.git

# ç¼–è¯‘ nginx + rtmp
WORKDIR /build/nginx-${NGINX_VERSION}
RUN ./configure \
    --prefix=/opt/nginx \
    --with-http_ssl_module \
    --add-module=../nginx-rtmp-module && \
    make -j$(nproc) && make install

############################
# ğŸš€ ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œé•œåƒ
############################
FROM alpine:3.19

# å®‰è£… nginx è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache openssl pcre zlib

# æ‹·è´ nginx ç¼–è¯‘äº§ç‰©
COPY --from=builder /opt/nginx /opt/nginx

# æ‹·è´ nginx.confï¼ˆå¦‚æœä½ è‡ªå®šä¹‰ï¼‰
COPY nginx.conf /opt/nginx/conf/nginx.conf

# ç¡®ä¿ HLS ç›®å½•å­˜åœ¨
RUN mkdir -p /opt/nginx/html/hls && mkdir -p /opt/nginx/logs

# ç«¯å£ï¼š1935 RTMP, 8080 HTTP
EXPOSE 1935 8080

WORKDIR /opt/nginx

CMD ["/opt/nginx/sbin/nginx", "-g", "daemon off;"]
